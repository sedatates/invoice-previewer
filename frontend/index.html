<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Invoice Generator</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/mustache@4.2.0/mustache.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <style>
      .template-thumb {
        transform: scale(0.18);
        transform-origin: top left;
        width: 555%;
        height: 555%;
      }
      .thumb-container {
        width: 80px;
        height: 113px;
        overflow: hidden;
        position: relative;
      }
      .template-name-overlay {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #334155;
        z-index: 10;
        transition: opacity 0.3s ease;
      }
      .template-loader {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(51, 65, 85, 0.9);
        z-index: 20;
      }
      input:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      .preview-frame {
        transform-origin: top left;
      }

      /* Sticky Preview Panel */
      .preview-panel {
        position: sticky;
        top: 24px;
        height: calc(100vh - 120px);
        align-self: flex-start;
      }

      /* Smooth scrollbar for editor */
      .editor-panel::-webkit-scrollbar {
        width: 6px;
      }
      .editor-panel::-webkit-scrollbar-track {
        background: transparent;
      }
      .editor-panel::-webkit-scrollbar-thumb {
        background: #475569;
        border-radius: 3px;
      }
      .editor-panel::-webkit-scrollbar-thumb:hover {
        background: #64748b;
      }

      @media (max-width: 1024px) {
        .main-grid {
          grid-template-columns: 1fr !important;
        }
        .preview-panel {
          position: relative;
          top: 0;
          height: auto;
        }
      }
    </style>
  </head>
  <body class="bg-slate-900 min-h-screen text-white">
    <!-- Header -->
    <header class="bg-slate-800 border-b border-slate-700 px-6 py-4">
      <div class="max-w-7xl mx-auto flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div
            class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
            <svg
              class="w-6 h-6 text-white"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
          </div>
          <div>
            <h1 class="text-xl font-bold">Invoice Generator</h1>
            <p class="text-slate-400 text-xs">Create professional invoices</p>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <button
            id="downloadPdfBtn"
            class="px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 rounded-lg font-medium transition-all flex items-center gap-2 text-sm">
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            Download PDF
          </button>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto p-6">
      <div class="main-grid grid grid-cols-[400px_1fr] gap-6 items-start">
        <!-- Left Panel - Editor -->
        <div class="editor-panel space-y-4 pr-2">
          <!-- Template Selector -->
          <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
            <label class="block text-sm font-medium text-slate-300 mb-3"
              >Template</label
            >
            <div id="templateGrid" class="grid grid-cols-4 gap-2">
              <!-- Templates will be injected here -->
            </div>
            <div id="templateLoading" class="hidden">
              <div class="grid grid-cols-4 gap-2">
                <div
                  class="animate-pulse bg-slate-700 rounded-lg h-[113px]"></div>
                <div
                  class="animate-pulse bg-slate-700 rounded-lg h-[113px]"></div>
                <div
                  class="animate-pulse bg-slate-700 rounded-lg h-[113px]"></div>
                <div
                  class="animate-pulse bg-slate-700 rounded-lg h-[113px]"></div>
              </div>
              <p class="text-xs text-slate-400 text-center mt-2">
                Loading templates...
              </p>
            </div>
          </div>

          <!-- Company Info -->
          <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
            <h3
              class="text-sm font-medium text-slate-300 mb-3 flex items-center gap-2">
              <svg
                class="w-4 h-4 text-blue-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
              </svg>
              Your Company
            </h3>
            <div class="space-y-3">
              <div>
                <label class="block text-xs text-slate-400 mb-1"
                  >Company Name</label
                >
                <input
                  type="text"
                  id="companyName"
                  class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white placeholder-slate-400"
                  placeholder="Acme Corporation" />
              </div>
              <div>
                <label class="block text-xs text-slate-400 mb-1"
                  >Logo URL (optional)</label
                >
                <input
                  type="text"
                  id="companyLogo"
                  class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white placeholder-slate-400"
                  placeholder="https://example.com/logo.png" />
              </div>
              <div>
                <label class="block text-xs text-slate-400 mb-1">Address</label>
                <textarea
                  id="companyAddress"
                  rows="2"
                  class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white placeholder-slate-400 resize-none"
                  placeholder="123 Business Ave&#10;San Francisco, CA 94102"></textarea>
              </div>
            </div>
          </div>

          <!-- Client Info -->
          <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
            <h3
              class="text-sm font-medium text-slate-300 mb-3 flex items-center gap-2">
              <svg
                class="w-4 h-4 text-green-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
              </svg>
              Bill To
            </h3>
            <div class="space-y-3">
              <div>
                <label class="block text-xs text-slate-400 mb-1"
                  >Client Name</label
                >
                <input
                  type="text"
                  id="clientName"
                  class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white placeholder-slate-400"
                  placeholder="John Smith" />
              </div>
              <div>
                <label class="block text-xs text-slate-400 mb-1"
                  >Client Address</label
                >
                <textarea
                  id="clientAddress"
                  rows="2"
                  class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white placeholder-slate-400 resize-none"
                  placeholder="456 Client Street&#10;New York, NY 10001"></textarea>
              </div>
            </div>
          </div>

          <!-- Invoice Details -->
          <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
            <h3
              class="text-sm font-medium text-slate-300 mb-3 flex items-center gap-2">
              <svg
                class="w-4 h-4 text-purple-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
              </svg>
              Invoice Details
            </h3>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-xs text-slate-400 mb-1"
                  >Invoice Number</label
                >
                <input
                  type="text"
                  id="invoiceNumber"
                  class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white"
                  placeholder="INV-001" />
              </div>
              <div>
                <label class="block text-xs text-slate-400 mb-1"
                  >Currency</label
                >
                <select
                  id="currency"
                  class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white">
                  <option value="$">$ USD</option>
                  <option value="€">€ EUR</option>
                  <option value="£">£ GBP</option>
                  <option value="₺">₺ TRY</option>
                </select>
              </div>
              <div>
                <label class="block text-xs text-slate-400 mb-1"
                  >Issue Date</label
                >
                <input
                  type="date"
                  id="issuedOn"
                  class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white" />
              </div>
              <div>
                <label class="block text-xs text-slate-400 mb-1"
                  >Due Date</label
                >
                <input
                  type="date"
                  id="dueOn"
                  class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white" />
              </div>
            </div>
          </div>

          <!-- Line Items -->
          <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
            <div class="flex items-center justify-between mb-3">
              <h3
                class="text-sm font-medium text-slate-300 flex items-center gap-2">
                <svg
                  class="w-4 h-4 text-amber-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                </svg>
                Line Items
              </h3>
              <button
                id="addItemBtn"
                class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1">
                <svg
                  class="w-3 h-3"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 4v16m8-8H4" />
                </svg>
                Add Item
              </button>
            </div>
            <div id="itemsContainer" class="space-y-2">
              <!-- Items will be injected here -->
            </div>
          </div>

          <!-- Tax & Notes -->
          <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
            <h3
              class="text-sm font-medium text-slate-300 mb-3 flex items-center gap-2">
              <svg
                class="w-4 h-4 text-rose-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
              </svg>
              Tax & Notes
            </h3>
            <div class="space-y-3">
              <div>
                <label class="block text-xs text-slate-400 mb-1"
                  >Tax Rate (%)</label
                >
                <input
                  type="number"
                  id="taxRate"
                  class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white"
                  placeholder="10"
                  min="0"
                  max="100" />
              </div>
              <div>
                <label class="block text-xs text-slate-400 mb-1">Notes</label>
                <textarea
                  id="notes"
                  rows="3"
                  class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white placeholder-slate-400 resize-none"
                  placeholder="Payment terms, bank details, etc."></textarea>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Panel - Preview (Sticky) -->
        <div
          class="preview-panel bg-slate-800 rounded-xl border border-slate-700 overflow-hidden flex flex-col shadow-2xl">
          <div
            class="bg-slate-700/50 px-4 py-3 border-b border-slate-700 flex items-center justify-between shrink-0">
            <span class="text-sm font-medium text-slate-300">Preview</span>
            <div class="flex items-center gap-2">
              <span id="totalDisplay" class="text-lg font-bold text-green-400"
                >$0.00</span
              >
            </div>
          </div>
          <div
            class="flex-1 overflow-auto p-4 bg-slate-600/30 flex justify-center">
            <div
              class="bg-white rounded-lg shadow-2xl overflow-hidden"
              style="width: 595px; min-height: 842px">
              <iframe
                id="previewFrame"
                class="w-full"
                style="height: 842px; border: none"></iframe>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Loading Overlay -->
    <div
      id="loadingOverlay"
      class="fixed inset-0 bg-slate-900/80 flex items-center justify-center z-50">
      <div class="text-center">
        <div
          class="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent mx-auto"></div>
        <p class="text-slate-400 mt-4">Loading templates...</p>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script>
      const CDN_BASE =
        "https://cdn.jsdelivr.net/gh/sedatates/invoice-previewer@main";
      const API_BASE = "https://invoice-backend-production-c91b.up.railway.app";

      let templates = [];
      let templateCache = {};
      let selectedTemplate = "minimal";
      let items = [
        { description: "Web Development", quantity: 10, rate: 150 },
        { description: "UI/UX Design", quantity: 5, rate: 120 },
      ];

      // Initialize default values
      function initDefaults() {
        document.getElementById("companyName").value = "Acme Corporation";
        document.getElementById("companyLogo").value = "";
        document.getElementById("companyAddress").value =
          "123 Business Ave\nSan Francisco, CA 94102\nhello@acme.com";
        document.getElementById("clientName").value = "John Smith";
        document.getElementById("clientAddress").value =
          "456 Client Street\nNew York, NY 10001";
        document.getElementById("invoiceNumber").value =
          "INV-" + String(Math.floor(Math.random() * 9000) + 1000);
        document.getElementById("currency").value = "$";

        const today = new Date();
        const dueDate = new Date(today);
        dueDate.setDate(dueDate.getDate() + 30);

        document.getElementById("issuedOn").value = today
          .toISOString()
          .split("T")[0];
        document.getElementById("dueOn").value = dueDate
          .toISOString()
          .split("T")[0];
        document.getElementById("taxRate").value = "10";
        document.getElementById("notes").value =
          "Thank you for your business!\nPayment via bank transfer.";

        renderItems();
      }

      // Render line items
      function renderItems() {
        const container = document.getElementById("itemsContainer");
        container.innerHTML = items
          .map(
            (item, index) => `
        <div class="bg-slate-700/50 rounded-lg p-3 space-y-2" data-index="${index}">
          <div class="flex items-center justify-between">
            <input type="text" value="${item.description}" placeholder="Description"
              class="flex-1 bg-slate-600 border border-slate-500 rounded px-2 py-1.5 text-sm text-white item-description">
            <button class="ml-2 text-slate-400 hover:text-red-400 transition-colors delete-item" data-index="${index}">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
            </button>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="text-[10px] text-slate-400">Quantity</label>
              <input type="number" value="${item.quantity}" min="1"
                class="w-full bg-slate-600 border border-slate-500 rounded px-2 py-1 text-sm text-white item-quantity">
            </div>
            <div>
              <label class="text-[10px] text-slate-400">Rate</label>
              <input type="number" value="${item.rate}" min="0" step="0.01"
                class="w-full bg-slate-600 border border-slate-500 rounded px-2 py-1 text-sm text-white item-rate">
            </div>
          </div>
        </div>
      `
          )
          .join("");

        // Add event listeners
        container.querySelectorAll(".delete-item").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const index = parseInt(e.currentTarget.dataset.index);
            items.splice(index, 1);
            renderItems();
            updatePreview();
          });
        });

        container.querySelectorAll("input").forEach((input) => {
          input.addEventListener("input", (e) => {
            const itemEl = e.target.closest("[data-index]");
            const index = parseInt(itemEl.dataset.index);
            if (e.target.classList.contains("item-description")) {
              items[index].description = e.target.value;
            } else if (e.target.classList.contains("item-quantity")) {
              items[index].quantity = parseFloat(e.target.value) || 0;
            } else if (e.target.classList.contains("item-rate")) {
              items[index].rate = parseFloat(e.target.value) || 0;
            }
            updatePreview();
          });
        });
      }

      // Get form data
      function getFormData() {
        const currency = document.getElementById("currency").value;
        return {
          invoiceNumber: document.getElementById("invoiceNumber").value,
          companyName: document.getElementById("companyName").value,
          companyLogo: document.getElementById("companyLogo").value,
          companyAddress: document
            .getElementById("companyAddress")
            .value.split("\n"),
          clientName: document.getElementById("clientName").value,
          clientAddress: document
            .getElementById("clientAddress")
            .value.split("\n"),
          issuedOn: document.getElementById("issuedOn").value,
          dueOn: document.getElementById("dueOn").value,
          items: items,
          taxRate: parseFloat(document.getElementById("taxRate").value) || 0,
          currency: currency,
          notes: document.getElementById("notes").value,
        };
      }

      // Prepare template data
      function prepareTemplateData(data) {
        const currency = data.currency || "$";

        let subtotal = 0;
        const itemsRows = data.items
          .map((item) => {
            const amount = item.quantity * item.rate;
            subtotal += amount;
            return `<tr class="border-b border-gray-200">
          <td class="py-2 px-2">${item.description}</td>
          <td class="py-2 px-2 text-right">${item.quantity}</td>
          <td class="py-2 px-2 text-right">${currency}${item.rate.toFixed(
              2
            )}</td>
          <td class="py-2 px-2 text-right">${currency}${amount.toFixed(2)}</td>
        </tr>`;
          })
          .join("");

        const taxRate = data.taxRate || 0;
        const taxAmount = subtotal * (taxRate / 100);
        const total = subtotal + taxAmount;

        // Update total display
        document.getElementById(
          "totalDisplay"
        ).textContent = `${currency}${total.toFixed(2)}`;

        const companyLines = Array.isArray(data.companyAddress)
          ? data.companyAddress.join("<br>")
          : data.companyAddress;

        const clientLines = `<strong>${data.clientName}</strong><br>${
          Array.isArray(data.clientAddress)
            ? data.clientAddress.join("<br>")
            : data.clientAddress
        }`;

        const notesBlock = data.notes
          ? `<div class="mt-6 p-4 bg-gray-50 rounded text-[9px] text-gray-600">
            <p class="font-bold text-gray-500 uppercase text-[8px] mb-1">Notes</p>
            <p class="whitespace-pre-line">${data.notes}</p>
          </div>`
          : "";

        return {
          ...data,
          hasLogo: !!data.companyLogo,
          companyLines,
          clientLines,
          itemsRows,
          subtotalFormatted: `${currency}${subtotal.toFixed(2)}`,
          taxRateLabel: taxRate,
          taxAmountFormatted: `${currency}${taxAmount.toFixed(2)}`,
          totalFormatted: `${currency}${total.toFixed(2)}`,
          notesBlock,
        };
      }

      // Fetch template
      async function fetchTemplate(templateId) {
        if (templateCache[templateId]) {
          return templateCache[templateId];
        }
        const response = await fetch(
          `${CDN_BASE}/templates/${templateId}.html`
        );
        const html = await response.text();
        templateCache[templateId] = html;
        return html;
      }

      // Update preview
      async function updatePreview() {
        try {
          const data = getFormData();
          const templateHtml = await fetchTemplate(selectedTemplate);
          const preparedData = prepareTemplateData(data);
          const renderedHtml = Mustache.render(templateHtml, preparedData);

          const iframe = document.getElementById("previewFrame");
          const doc = iframe.contentDocument || iframe.contentWindow.document;
          doc.open();
          doc.write(renderedHtml);
          doc.close();
        } catch (error) {
          console.error("Preview error:", error);
        }
      }

      // Render template grid with names first, then lazy load thumbnails
      function renderTemplateGrid() {
        const grid = document.getElementById("templateGrid");
        grid.innerHTML = templates
          .map(
            (template) => `
        <button class="template-btn rounded-lg overflow-hidden border-2 transition-all ${
          template.id === selectedTemplate
            ? "border-blue-500 ring-2 ring-blue-500/30"
            : "border-slate-600 hover:border-slate-500"
        }"
          data-template="${template.id}" title="${template.label}">
          <div class="thumb-container bg-slate-700 flex items-center justify-center relative">
            <div class="template-name-overlay absolute inset-0 flex items-center justify-center bg-slate-700 z-10">
              <span class="text-[10px] text-slate-300 text-center px-1 font-medium">${
                template.label
              }</span>
            </div>
            <div class="template-loader absolute inset-0 flex items-center justify-center bg-slate-700/90 z-20 hidden">
              <div class="w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
            </div>
            <iframe data-src="${CDN_BASE}/templates/${
              template.id
            }.html" class="template-thumb pointer-events-none opacity-0 transition-opacity duration-300" sandbox="allow-scripts"></iframe>
          </div>
        </button>
      `
          )
          .join("");

        grid.querySelectorAll(".template-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            selectedTemplate = btn.dataset.template;
            grid.querySelectorAll(".template-btn").forEach((b) => {
              b.classList.remove(
                "border-blue-500",
                "ring-2",
                "ring-blue-500/30"
              );
              b.classList.add("border-slate-600");
            });
            btn.classList.remove("border-slate-600");
            btn.classList.add("border-blue-500", "ring-2", "ring-blue-500/30");
            updatePreview();
          });
        });

        // Lazy load template thumbnails
        loadTemplateThumbnails();
      }

      // Load template thumbnails progressively
      function loadTemplateThumbnails() {
        const iframes = document.querySelectorAll(
          "#templateGrid iframe[data-src]"
        );

        iframes.forEach((iframe, index) => {
          const container = iframe.closest(".thumb-container");
          const loader = container.querySelector(".template-loader");
          const nameOverlay = container.querySelector(".template-name-overlay");

          // Show loader
          loader.classList.remove("hidden");

          // Stagger the loading slightly for better UX
          setTimeout(() => {
            iframe.src = iframe.dataset.src;

            iframe.onload = () => {
              // Hide loader and name overlay, show thumbnail
              loader.classList.add("hidden");
              nameOverlay.classList.add("opacity-0");
              iframe.classList.remove("opacity-0");

              // Remove name overlay after fade
              setTimeout(() => {
                nameOverlay.classList.add("hidden");
              }, 300);
            };

            iframe.onerror = () => {
              loader.classList.add("hidden");
              // Keep name visible on error
            };
          }, index * 150);
        });
      }

      // Download PDF
      async function downloadPdf() {
        const btn = document.getElementById("downloadPdfBtn");
        const originalHtml = btn.innerHTML;
        btn.innerHTML =
          '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Generating...';
        btn.disabled = true;

        try {
          const data = getFormData();
          const response = await fetch(`${API_BASE}/render`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              template: selectedTemplate,
              data: data,
              options: {
                format: "A4",
                marginTop: "10mm",
                marginBottom: "10mm",
              },
            }),
          });

          if (!response.ok) throw new Error("PDF generation failed");

          const blob = await response.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `${data.invoiceNumber || "invoice"}.pdf`;
          a.click();
          URL.revokeObjectURL(url);
        } catch (error) {
          console.error("Download error:", error);
          alert("Failed to generate PDF. Please try again.");
        } finally {
          btn.innerHTML = originalHtml;
          btn.disabled = false;
        }
      }

      // Initialize
      async function init() {
        try {
          const response = await fetch(`${CDN_BASE}/index.json`);
          const data = await response.json();
          templates = data.templates;

          initDefaults();
          renderTemplateGrid();

          // Add event listeners for form inputs
          const inputs = document.querySelectorAll(
            "#companyName, #companyLogo, #companyAddress, #clientName, #clientAddress, #invoiceNumber, #currency, #issuedOn, #dueOn, #taxRate, #notes"
          );
          inputs.forEach((input) => {
            input.addEventListener("input", updatePreview);
            input.addEventListener("change", updatePreview);
          });

          // Add item button
          document
            .getElementById("addItemBtn")
            .addEventListener("click", () => {
              items.push({ description: "", quantity: 1, rate: 0 });
              renderItems();
              updatePreview();
            });

          // Download PDF button
          document
            .getElementById("downloadPdfBtn")
            .addEventListener("click", downloadPdf);

          // Initial preview
          await updatePreview();

          document.getElementById("loadingOverlay").classList.add("hidden");
        } catch (error) {
          console.error("Init error:", error);
          document.getElementById("loadingOverlay").innerHTML = `
          <div class="text-center text-red-400">
            <p class="text-lg font-semibold">Failed to load</p>
            <p class="text-sm mt-2">${error.message}</p>
            <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-slate-700 rounded-lg">Retry</button>
          </div>
        `;
        }
      }

      init();
    </script>
  </body>
</html>
